name: Daily Release

on:
  schedule:
    # Daily UTC 00:30 release
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      release_date:
        description: "Specify release date (YYYY-MM-DD)"
        required: false
        type: string

env:
  NODE_VERSION: "20"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          # version: latest # for packageJson.packageManager
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify dependencies installation
        run: |
          echo "ðŸ“¦ Verifying Node.js can find installed packages..."
          node -e "console.log('âœ… commander found:', require.resolve('commander'))" || echo "âŒ commander not found"
          echo "ðŸ“‚ node_modules contents:"
          ls -la node_modules/ | head -10

      - name: Install xz-utils
        run: sudo apt-get update && sudo apt-get install -y xz-utils

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Set release date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.release_date }}" ]; then
            echo "RELEASE_DATE=${{ github.event.inputs.release_date }}" >> $GITHUB_ENV
            echo "date=${{ github.event.inputs.release_date }}" >> $GITHUB_OUTPUT
          else
            RELEASE_DATE=$(date -u +"%Y-%m-%d")
            echo "RELEASE_DATE=${RELEASE_DATE}" >> $GITHUB_ENV
            echo "date=${RELEASE_DATE}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch auto-update branch
        run: |
          echo "ðŸ“‚ Current branch: $(git branch --show-current)"
          echo "ðŸ”„ Fetching all remote branches..."
          
          # Fetch all remote branches and tags
          git fetch --all --prune
          
          # List available branches to verify auto-update exists
          echo "ðŸ“‹ Available local branches:"
          git branch -a
          
          # Check if auto-update branch exists remotely
          if git ls-remote --exit-code --heads origin auto-update > /dev/null; then
            echo "âœ… auto-update branch found on remote"
            # Create local tracking branch if it doesn't exist
            if ! git show-ref --verify --quiet refs/heads/auto-update; then
              echo "ðŸ”§ Creating local auto-update branch"
              git checkout -b auto-update origin/auto-update
              git checkout main
            fi
          else
            echo "âŒ auto-update branch not found on remote"
            exit 1
          fi

      - name: Copy data from auto-update branch
        run: |
          echo "ðŸ”„ Checking auto-update branch contents..."
          
          # Check what's in auto-update branch
          git ls-tree -r auto-update
          
          echo "ðŸ”„ Copying latest data from auto-update branch..."
          
          # Copy data directories from auto-update branch (force overwrite)
          git checkout auto-update -- table/ || echo "âš ï¸ No table data found"
          git checkout auto-update -- asns/ || echo "âš ï¸ No asns data found" 
          git checkout auto-update -- tags/ || echo "âš ï¸ No tags data found"
          
          echo "ðŸ“Š Data files copied - checking directories:"
          ls -la table/ 2>/dev/null || echo "âš ï¸ table/ directory not found"
          ls -la asns/ 2>/dev/null || echo "âš ï¸ asns/ directory not found"  
          ls -la tags/ 2>/dev/null || echo "âš ï¸ tags/ directory not found"
          
          echo "ðŸ“Š Checking specific data files:"
          ls -la table/table-original.jsonl 2>/dev/null || echo "âš ï¸ table-original.jsonl not found"
          ls -la asns/asns.csv 2>/dev/null || echo "âš ï¸ asns.csv not found"
          find tags/ -name "*.csv" 2>/dev/null || echo "âš ï¸ No tag CSV files found"

      - name: Generate release files
        env:
          NODE_ENV: production
        run: |
          echo "ðŸš€ Generating ${RELEASE_DATE} release files from existing data..."
          
          # Convert existing data to release format with date
          if [ -f "table/table-original.jsonl" ]; then
            echo "âœ… Found table data, creating release files..."
            cp "table/table-original.jsonl" "table-${RELEASE_DATE}.jsonl"
            gzip -c "table-${RELEASE_DATE}.jsonl" > "table-${RELEASE_DATE}.jsonl.gz"
            xz -c "table-${RELEASE_DATE}.jsonl" > "table-${RELEASE_DATE}.jsonl.xz"
            echo "ðŸ“Š Table files: $(ls -la table-${RELEASE_DATE}.*)"
          else
            echo "âŒ No table/table-original.jsonl found"
          fi
          
          if [ -f "asns/asns.csv" ]; then
            echo "âœ… Found ASN data, creating release files..."
            cp "asns/asns.csv" "asns-${RELEASE_DATE}.csv"
            gzip -c "asns-${RELEASE_DATE}.csv" > "asns-${RELEASE_DATE}.csv.gz"
            xz -c "asns-${RELEASE_DATE}.csv" > "asns-${RELEASE_DATE}.csv.xz"
            echo "ðŸ“Š ASN files: $(ls -la asns-${RELEASE_DATE}.*)"
          else
            echo "âŒ No asns/asns.csv found"
          fi
          
          # Process tags data
          tag_count=0
          for tag_dir in tags/*/; do
            if [ -d "$tag_dir" ]; then
              tag_name=$(basename "$tag_dir")
              echo "ðŸ” Checking tag directory: $tag_dir for file: ${tag_dir}tags-${tag_name}.csv"
              if [ -f "${tag_dir}tags-${tag_name}.csv" ]; then
                echo "âœ… Found tag data for: $tag_name"
                cp "${tag_dir}tags-${tag_name}.csv" "tags-${tag_name}-${RELEASE_DATE}.csv"
                gzip -c "tags-${tag_name}-${RELEASE_DATE}.csv" > "tags-${tag_name}-${RELEASE_DATE}.csv.gz"
                xz -c "tags-${tag_name}-${RELEASE_DATE}.csv" > "tags-${tag_name}-${RELEASE_DATE}.csv.xz"
                tag_count=$((tag_count + 1))
              else
                echo "âŒ No CSV file found in $tag_dir"
              fi
            fi
          done
          
          echo "ðŸ“Š Processed $tag_count tag categories"
          echo "ðŸ“Š All generated release files:"
          ls -la *-${RELEASE_DATE}.* 2>/dev/null || echo "âš ï¸ No release files generated"

      - name: Create release assets
        run: |
          echo "ðŸ“¦ Preparing release assets..."

          # Create release directory
          mkdir -p release-assets

          # Copy release files
          cp table-${RELEASE_DATE}.jsonl.gz release-assets/ 2>/dev/null || echo "âš ï¸ No routing table .gz file found"
          cp table-${RELEASE_DATE}.jsonl.xz release-assets/ 2>/dev/null || echo "âš ï¸ No routing table .xz file found"
          cp asns-${RELEASE_DATE}.csv.gz release-assets/ 2>/dev/null || echo "âš ï¸ No ASN mapping .gz file found"
          cp asns-${RELEASE_DATE}.csv.xz release-assets/ 2>/dev/null || echo "âš ï¸ No ASN mapping .xz file found"
          cp tags-*-${RELEASE_DATE}.csv.gz release-assets/ 2>/dev/null || echo "âš ï¸ No tag .gz file found"
          cp tags-*-${RELEASE_DATE}.csv.xz release-assets/ 2>/dev/null || echo "âš ï¸ No tag .xz file found"

          # Check if there are any files
          if [ -z "$(ls -A release-assets/)" ]; then
            echo "âŒ No release files found"
            exit 1
          fi

          echo "ðŸ“‹ Release assets list:"
          ls -la release-assets/

      - name: Calculate checksums
        run: |
          cd release-assets
          sha256sum * > checksums.sha256
          echo "ðŸ” Generating checksums file:"
          cat checksums.sha256

      - name: Create release notes
        run: |
          cat > release-notes.md << EOF
          # BGP.Tools OpenDB - ${RELEASE_DATE}

          ðŸ“… **Release date**: ${RELEASE_DATE}

          ## ðŸ“¦ Data included

          ### Full-Table Archive
          - \`table-${RELEASE_DATE}.jsonl.gz\` - Global routing table data (gzip compressed)
          - \`table-${RELEASE_DATE}.jsonl.xz\` - Global routing table data (xz compressed, smaller file)

          ### ASN-Mapping Table
          - \`asns-${RELEASE_DATE}.csv.gz\` - ASN to name mapping (gzip compressed)
          - \`asns-${RELEASE_DATE}.csv.xz\` - ASN to name mapping (xz compressed, smaller file)

          ### ASN-Tags Data
          - \`tags-*-${RELEASE_DATE}.csv.gz\` - Various category tag data (gzip compressed)
          - \`tags-*-${RELEASE_DATE}.csv.xz\` - Various category tag data (xz compressed, smaller file)

          ### Checksums
          - \`checksums.sha256\` - SHA256 checksums for all files

          ## ðŸ“Š Data sources

          All data comes from [bgp.tools](https://bgp.tools) HTTP API, obtained at: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## ðŸ”— Related links

          - [Project homepage](https://github.com/${{ github.repository }})
          - [BGP.Tools](https://bgp.tools)
          - [Auto-update branch](https://github.com/${{ github.repository }}/tree/auto-update)

          ---

          *This release is automatically generated by GitHub Actions*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: BGP.Tools OpenDB - ${{ steps.date.outputs.date }}
          body_path: release-notes.md
          files: |
            release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up release files
        run: |
          echo "ðŸ§¹ Cleaning local release files..."
          rm -f table-${RELEASE_DATE}.*
          rm -f asns-${RELEASE_DATE}.*
          rm -f tags-*-${RELEASE_DATE}.*
          rm -rf release-assets/
          rm -f release-notes.md

          echo "âœ… Release completed: v${RELEASE_DATE}"
