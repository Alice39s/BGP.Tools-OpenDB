name: Daily Release

on:
  workflow_dispatch:
    inputs:
      release_date:
        description: "Specify release date (YYYY-MM-DD)"
        required: false
        type: string
      source_branch:
        description: "Branch to release from"
        required: false
        type: string
        default: "auto-update"
      refresh_data:
        description: "Refresh data before release (recommended)"
        required: false
        type: boolean
        default: true
  schedule:
    - cron: "30 0 * * *"

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.11.0"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.source_branch != '' && github.event.inputs.source_branch || 'auto-update' }}

      - name: Refresh data (manual trigger only)
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.refresh_data == 'true' || github.event.inputs.refresh_data == true) }}
        run: |
          echo "ðŸ”„ Running data update before release..."
          pnpm install --frozen-lockfile
          pnpm fetch:all
          echo "âœ… Data refresh complete."

      - name: Setup tooling
        uses: ./.github/actions/setup-runtime
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          install-deps: "false"
          setup-go: "false"
          build-mmdbwriter: "false"

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Set release date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.release_date }}" ]; then
            RELEASE_DATE="${{ github.event.inputs.release_date }}"
          else
            RELEASE_DATE=$(date -u +"%Y-%m-%d")
          fi
          echo "RELEASE_DATE=${RELEASE_DATE}" >> $GITHUB_ENV
          echo "date=${RELEASE_DATE}" >> $GITHUB_OUTPUT

      - name: Generate release files
        run: |
          set -euo pipefail

          echo "ðŸš€ Generating ${RELEASE_DATE} release files from existing data..."
          ls -la table/ asns/ tags/ 2>/dev/null || true

          mkdir -p release-assets

          if [ -f "table/table-original.jsonl" ]; then
            cp "table/table-original.jsonl" "table-${RELEASE_DATE}.jsonl"
            gzip -c "table-${RELEASE_DATE}.jsonl" > "table-${RELEASE_DATE}.jsonl.gz"
            xz -c "table-${RELEASE_DATE}.jsonl" > "table-${RELEASE_DATE}.jsonl.xz"
            cp table-${RELEASE_DATE}.jsonl.* release-assets/ || true
          else
            echo "âŒ table/table-original.jsonl not found"
          fi

          if [ -f "asns/asns.csv" ]; then
            cp "asns/asns.csv" "asns-${RELEASE_DATE}.csv"
            gzip -c "asns-${RELEASE_DATE}.csv" > "asns-${RELEASE_DATE}.csv.gz"
            xz -c "asns-${RELEASE_DATE}.csv" > "asns-${RELEASE_DATE}.csv.xz"
            cp asns-${RELEASE_DATE}.csv.* release-assets/ || true
          else
            echo "âŒ asns/asns.csv not found"
          fi

          if [ -d "tags" ]; then
            for tag_dir in tags/*/; do
              [ -d "$tag_dir" ] || continue
              tag_name=$(basename "$tag_dir")
              csv_file="${tag_dir}tags-${tag_name}.csv"
              if [ -f "$csv_file" ]; then
                cp "$csv_file" "tags-${tag_name}-${RELEASE_DATE}.csv"
                gzip -c "tags-${tag_name}-${RELEASE_DATE}.csv" > "tags-${tag_name}-${RELEASE_DATE}.csv.gz"
                xz -c "tags-${tag_name}-${RELEASE_DATE}.csv" > "tags-${tag_name}-${RELEASE_DATE}.csv.xz"
                cp tags-${tag_name}-${RELEASE_DATE}.csv.* release-assets/ || true
              fi
            done
          fi

          if [ -z "$(ls -A release-assets)" ]; then
            echo "âŒ release-assets is empty"
            exit 1
          fi

      - name: Calculate checksums
        run: |
          cd release-assets
          sha256sum * > checksums.sha256
          cd -

      - name: Upload release assets artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-files-${{ steps.date.outputs.date }}
          path: release-assets

      - name: Generate release notes
        run: |
          cat > release-notes.md << EOF
          # BGP.Tools OpenDB - ${RELEASE_DATE}

          ðŸ“… **Release date**: ${RELEASE_DATE}

          ## ðŸ“¦ Data included

          ### Full-Table Archive
          - \`table-${RELEASE_DATE}.jsonl.gz\` - Global routing table data (gzip compressed)
          - \`table-${RELEASE_DATE}.jsonl.xz\` - Global routing table data (xz compressed, smaller file)

          ### ASN-Mapping Table
          - \`asns-${RELEASE_DATE}.csv.gz\` - ASN to name mapping (gzip compressed)
          - \`asns-${RELEASE_DATE}.csv.xz\` - ASN to name mapping (xz compressed, smaller file)

          ### ASN-Tags Data
          - \`tags-*-${RELEASE_DATE}.csv.gz\` - Various category tag data (gzip compressed)
          - \`tags-*-${RELEASE_DATE}.csv.xz\` - Various category tag data (xz compressed, smaller file)

          ### Checksums
          - \`checksums.sha256\` - SHA256 checksums for all files

          ## ðŸ“Š Data sources

          All data comes from [bgp.tools](https://bgp.tools) HTTP API, obtained at: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## ðŸ”— Related links

          - [Project homepage](https://github.com/${{ github.repository }})
          - [BGP.Tools](https://bgp.tools)
          - [Auto-update branch](https://github.com/${{ github.repository }}/tree/auto-update)

          ---

          *This release is automatically generated by GitHub Actions*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: BGP.Tools OpenDB - ${{ steps.date.outputs.date }}
          body_path: release-notes.md
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        run: |
          rm -rf release-assets release-notes.md table-${RELEASE_DATE}.jsonl* asns-${RELEASE_DATE}.csv* tags-*-${RELEASE_DATE}.csv*
