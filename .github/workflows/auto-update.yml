name: Auto Update BGP Data

on:
  schedule:
    # Routing table data: updated every 2 hours
    - cron: "0 */2 * * *"
  workflow_dispatch:
    inputs:
      data_type:
        description: "Select the data type to update"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - table
          - asns
          - tags

env:
  NODE_VERSION: "20"

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install xz-utils
        run: sudo apt-get update && sudo apt-get install -y xz-utils

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.4'

      - name: Compile MMDB writer binary
        run: |
          echo "ğŸ”§ Compiling Go MMDB writer binary..."
          chmod +x scripts/init-mmdbwriter.sh
          ./scripts/init-mmdbwriter.sh

          # Verify binary was created
          if [ -f "./mmdbwriter.bin" ]; then
            echo "âœ… MMDB writer binary compiled successfully"
            ls -la ./mmdbwriter.bin
          else
            echo "âŒ Failed to compile MMDB writer binary"
            exit 1
          fi

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Setup auto-update branch
        run: |
          echo "ğŸ”„ Setting up auto-update branch..."

          # Fetch all remote branches to ensure we have latest refs
          git fetch --all --prune

          # Check if auto-update branch exists on remote
          if git ls-remote --heads origin auto-update | grep -q auto-update; then
            echo "ğŸ“ Auto-update branch exists on remote, checking it out..."
            git checkout auto-update
            git pull origin auto-update || true
          else
            echo "ğŸ“ Auto-update branch doesn't exist, creating it..."
            git checkout -b auto-update
            # Push the new branch immediately to establish it on remote
            git push -u origin auto-update
          fi

          echo "âœ… Successfully set up auto-update branch"

      - name: Update table data
        if: ${{ github.event.inputs.data_type == 'all' || github.event.inputs.data_type == 'table' || github.event_name == 'schedule' }}
        run: |
          echo "ğŸ”„ Updating routing table data..."
          node src/index.js fetch-table

          # Check if there are any changes in table directory
          if [ -n "$(git status --porcelain table/)" ]; then
            echo "ğŸ“Š Detected routing table data changes"
            git add table/
            git commit -m "ğŸ”„ [Auto-Update] routing table data $(date -u +"%Y-%m-%d %H:%M UTC")"

            # Clean old files, keep the latest 24 versions
            find table/ -name "table-*.jsonl*" -type f -printf '%T@ %p\n' | sort -rn | tail -n +25 | cut -d' ' -f2- | xargs -r rm -f
            git add table/
            git commit -m "ğŸ§¹ [Auto-Update] Clean old routing table files $(date -u +"%Y-%m-%d %H:%M UTC")" || true
          else
            echo "ğŸ“Š Routing table data has no changes"
          fi

      - name: Update ASN data
        if: ${{ github.event.inputs.data_type == 'all' || github.event.inputs.data_type == 'asns' || (github.event_name == 'schedule' && github.event.schedule == '0 1 * * *') }}
        run: |
          echo "ğŸ”„ Updating ASN mapping data..."
          node src/index.js fetch-asns

          # Check if there are any changes
          if [ -n "$(git status --porcelain asns/)" ]; then
            echo "ğŸ“Š Detected ASN mapping data changes"
            git add asns/
            git commit -m "ğŸ”„ [Auto-Update] ASN mapping data $(date -u +"%Y-%m-%d %H:%M UTC")"

            # Clean old files, keep the latest 3 versions
            find asns/ -name "asns-*.csv*" -type f -printf '%T@ %p\n' | sort -rn | tail -n +4 | cut -d' ' -f2- | xargs -r rm -f
            git add asns/
            git commit -m "ğŸ§¹ [Auto-Update] Clean old ASN files $(date -u +"%Y-%m-%d %H:%M UTC")" || true
          else
            echo "ğŸ“Š ASN mapping data has no changes"
          fi

      - name: Update tags data
        if: ${{ github.event.inputs.data_type == 'all' || github.event.inputs.data_type == 'tags' || (github.event_name == 'schedule' && github.event.schedule == '0 1 * * *') }}
        run: |
          echo "ğŸ”„ Updating tag data..."
          node src/index.js fetch-tags

          # Check if there are any changes
          if [ -n "$(git status --porcelain tags/)" ]; then
            echo "ğŸ“Š Detected tag data changes"
            git add tags/
            git commit -m "ğŸ”„ [Auto-Update] tag data $(date -u +"%Y-%m-%d %H:%M UTC")"

            # Clean old files, keep the latest 3 versions per tag
            find tags/ -name "tags-*-*.csv*" -type f -printf '%T@ %p\n' | sort -rn | tail -n +4 | cut -d' ' -f2- | xargs -r rm -f
            git add tags/
            git commit -m "ğŸ§¹ [Auto-Update] Clean old tag files $(date -u +"%Y-%m-%d %H:%M UTC")" || true
          else
            echo "ğŸ“Š Tag data has no changes"
          fi

      - name: Push changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“¤ Pushing changes to auto-update branch"
            git push origin auto-update
            echo "âœ… Changes pushed successfully"
          else
            echo "ğŸ“¤ No changes to push"
          fi

  # Daily job: update ASN and tag data (Archive Data)
  daily-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 1 * * *'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install xz-utils
        run: sudo apt-get update && sudo apt-get install -y xz-utils

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.4'

      - name: Compile MMDB writer binary
        run: |
          echo "ğŸ”§ Compiling Go MMDB writer binary..."
          chmod +x scripts/init-mmdbwriter.sh
          ./scripts/init-mmdbwriter.sh

          # Verify binary was created
          if [ -f "./mmdbwriter.bin" ]; then
            echo "âœ… MMDB writer binary compiled successfully"
            ls -la ./mmdbwriter.bin
          else
            echo "âŒ Failed to compile MMDB writer binary"
            exit 1
          fi

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Setup auto-update branch
        run: |
          echo "ğŸ”„ Setting up auto-update branch..."

          # Fetch all remote branches to ensure we have latest refs
          git fetch --all --prune

          # Check if auto-update branch exists on remote
          if git ls-remote --heads origin auto-update | grep -q auto-update; then
            echo "ğŸ“ Auto-update branch exists on remote, checking it out..."
            git checkout auto-update
            git pull origin auto-update || true
          else
            echo "ğŸ“ Auto-update branch doesn't exist, creating it..."
            git checkout -b auto-update
            # Push the new branch immediately to establish it on remote
            git push -u origin auto-update
          fi

          echo "âœ… Successfully set up auto-update branch"

      - name: Update ASN and tags data
        run: |
          echo "ğŸ”„ [Daily] update ASN and tag data..."

          # Update ASN data
          node src/index.js fetch-asns
          if [ -n "$(git status --porcelain asns/)" ]; then
            echo "ğŸ“Š Detected ASN mapping data changes"
            git add asns/
            git commit -m "ğŸ”„ [Daily] ASN mapping data $(date -u +"%Y-%m-%d")"

            # Clean old files, keep the latest 3 versions
            find asns/ -name "asns-*.csv*" -type f -printf '%T@ %p\n' | sort -rn | tail -n +4 | cut -d' ' -f2- | xargs -r rm -f
            git add asns/
            git commit -m "ğŸ§¹ [Daily] Clean old ASN files $(date -u +"%Y-%m-%d")" || true
          else
            echo "ğŸ“Š ASN mapping data has no changes"
          fi

          # Update tag data
          node src/index.js fetch-tags
          if [ -n "$(git status --porcelain tags/)" ]; then
            echo "ğŸ“Š Detected tag data changes"
            git add tags/
            git commit -m "ğŸ”„ [Daily] tag data $(date -u +"%Y-%m-%d")"

            # Clean old files, keep the latest 3 versions per tag
            find tags/ -name "tags-*-*.csv*" -type f -printf '%T@ %p\n' | sort -rn | tail -n +4 | cut -d' ' -f2- | xargs -r rm -f
            git add tags/
            git commit -m "ğŸ§¹ [Daily] Clean old tag files $(date -u +"%Y-%m-%d")" || true
          else
            echo "ğŸ“Š Tag data has no changes"
          fi

      - name: Push changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“¤ Pushing [Daily] update to auto-update branch"
            git push origin auto-update
            echo "âœ… Daily changes pushed successfully"
          else
            echo "ğŸ“¤ No changes to push"
          fi
